{% extends "base.html" %}
{% block title %}Moje knjige{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mt-4">
    <h2>
        <i class="fa-solid fa-book-bookmark"></i> Moje knjige
    </h2>
    <a href="{{ url_for('books.create_book') }}" class="btn btn-primary">
        <i class="fa-solid fa-plus"></i> Dodaj novu knjigu
    </a>
</div>

<hr>

<!-- PRETRAGA -->
<div class="card mb-4 shadow-sm">
    <div class="card-body">
        <form method="GET" action="{{ url_for('books.my_books') }}">
            <div class="row g-3">
                <div class="col-md-10">
                    <label for="search" class="form-label">
                        <i class="fa-solid fa-search"></i> Pretraži moje knjige
                    </label>
                    <input type="text" 
                           class="form-control" 
                           id="search" 
                           name="search" 
                           placeholder="Unesite naslov..."
                           value="{{ search_query or '' }}">
                </div>
                <div class="col-md-2 d-flex align-items-end gap-2">
                    <button type="submit" class="btn btn-primary flex-fill">
                        <i class="fa-solid fa-search"></i> Traži
                    </button>
                    <a href="{{ url_for('books.my_books') }}" class="btn btn-secondary">
                        <i class="fa-solid fa-rotate-right"></i>
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Statistika -->
<div class="alert alert-info">
    <i class="fa-solid fa-chart-bar"></i>
    <strong>Ukupno mojih knjiga: {{ total_books }}</strong>
    {% if search_query %}
        (Prikazano {{ books|length }} prema pretrazi "{{ search_query }}")
    {% endif %}
</div>

{% if books|length == 0 %}
    <div class="card p-5 text-center">
        <i class="fa-solid fa-book-open" style="font-size: 60px; color: #ccc;"></i>
        <h4 class="mt-3">
            {% if search_query %}
                Nema knjiga koje odgovaraju pretrazi
            {% else %}
                Još niste dodali niti jednu knjigu
            {% endif %}
        </h4>
        <p class="text-muted">
            {% if not search_query %}
                Kliknite "Dodaj novu knjigu" kako biste počeli dijeliti svoje knjige!
            {% endif %}
        </p>
        {% if not search_query %}
        <div class="mt-3">
            <a href="{{ url_for('books.create_book') }}" class="btn btn-primary btn-lg">
                <i class="fa-solid fa-plus"></i> Dodaj prvu knjigu
            </a>
        </div>
        {% endif %}
    </div>

{% else %}

    <div class="row mt-3">
        {% for book in books %}
        
            <div class="col-md-4 mb-4">
                <div class="card h-100 shadow-sm">
                    {% if book.image %}
                        <img src="{{ url_for('static', filename='uploads/' ~ book.image) }}"
                            class="img-fluid rounded mb-2"
                            style="max-height: 250px; object-fit: cover;">
                    {% endif %}

                    <div class="card-body">
                        <h5 class="card-title">{{ book['title'] }}</h5>
                        <p class="text-muted small mb-2">
                            <i class="fa-solid fa-user"></i> {{ book['author'] }}
                        </p>

                        <div class="card-text book-description-preview">
                            {{ book['description_html']|safe|truncate(150) }}
                        </div>

                        <a href="{{ url_for('books.book_detail', book_id=book['_id']) }}" 
                           class="btn btn-sm btn-outline-primary mt-2">
                            <i class="fa-solid fa-book-open"></i> Opširnije
                        </a>

                        {% if book.created_at %}
                        <p class="text-muted small mt-3 mb-0">
                            <i class="fa-solid fa-calendar"></i> 
                            Dodano: {{ book['created_at'].strftime('%d.%m.%Y') }}
                        </p>
                        {% endif %}

                        <div class="d-flex gap-2 mt-3">
                            <a href="{{ url_for('books.edit_book', book_id=book['_id']) }}" 
                               class="btn btn-sm btn-warning flex-fill">
                                <i class="fa-solid fa-edit"></i> Uredi
                            </a>

                            <form method="POST" 
                                  action="{{ url_for('books.delete_book', book_id=book['_id']) }}"
                                  onsubmit="return confirm('Sigurno želiš obrisati ovu knjigu?');"
                                  class="flex-fill">
                                <button class="btn btn-sm btn-danger w-100">
                                    <i class="fa-solid fa-trash"></i> Obriši
                                </button>
                            </form>
                        </div>
                    </div>

                </div>
            </div>

        {% endfor %}
    </div>

    <!-- PAGINACIJA -->
    {% if total_pages > 1 %}
    <nav aria-label="Page navigation" class="mt-4">
        <ul class="pagination justify-content-center">
            
            <!-- Previous -->
            <li class="page-item {% if page == 1 %}disabled{% endif %}">
                <a class="page-link" 
                   href="{{ url_for('books.my_books', page=page-1, search=search_query) }}">
                    <i class="fa-solid fa-chevron-left"></i> Prethodna
                </a>
            </li>

            <!-- Page numbers -->
            {% for p in range(1, total_pages + 1) %}
                {% if p == page %}
                    <li class="page-item active">
                        <span class="page-link">{{ p }}</span>
                    </li>
                {% elif p == 1 or p == total_pages or (p >= page - 2 and p <= page + 2) %}
                    <li class="page-item">
                        <a class="page-link" 
                           href="{{ url_for('books.my_books', page=p, search=search_query) }}">
                            {{ p }}
                        </a>
                    </li>
                {% elif p == page - 3 or p == page + 3 %}
                    <li class="page-item disabled">
                        <span class="page-link">...</span>
                    </li>
                {% endif %}
            {% endfor %}

            <!-- Next -->
            <li class="page-item {% if page == total_pages %}disabled{% endif %}">
                <a class="page-link" 
                   href="{{ url_for('books.my_books', page=page+1, search=search_query) }}">
                    Sljedeća <i class="fa-solid fa-chevron-right"></i>
                </a>
            </li>

        </ul>
    </nav>

    <!-- Info o paginaciji -->
    <div class="text-center text-muted small mb-4">
        Stranica {{ page }} od {{ total_pages }} 
        ({{ total_books }} {{ 'knjiga' if total_books != 1 else 'knjiga' }})
    </div>
    {% endif %}

{% endif %}

<style>
    .book-description-preview {
        max-height: 120px;
        overflow: hidden;
        font-size: 0.95rem;
        line-height: 1.5;
    }
    
    .pagination .page-link {
        color: #5a3e2b;
    }
    
    .pagination .page-item.active .page-link {
        background-color: #5a3e2b;
        border-color: #5a3e2b;
    }
</style>

{% endblock %}